function P(t){const s={appealReferenceNumber:"NOT_FOUND",siteVisitDate:"NOT_FOUND",decisionDate:"NOT_FOUND",lpa:"NOT_FOUND",inspector:"NOT_FOUND",decisionOutcome:"NOT_FOUND"};if(!t||typeof t!="string")return s;const a=t.substring(0,1500);t.length>100&&(console.log("=== METADATA EXTRACTION DEBUG ==="),console.log("Original text length:",t.length),console.log("Header section (first 1000 chars):"),console.log(a.substring(0,1e3)),console.log(`
--- Line breaks preserved ---`),console.log(a.substring(0,1e3).replace(/\n/g,"\\n")));const n=a.trim(),r=a.replace(/\s+/g," ").trim();return t.length>100&&(console.log(`
--- After cleaning (first 300 chars) ---`),console.log(r.substring(0,300))),s.appealReferenceNumber=F(n,r),s.siteVisitDate=x(n,r),s.decisionDate=R(n,r),s.lpa=S(n,r),s.inspector=k(n,r),s.decisionOutcome=$(n,r),t.length>100&&(console.log(`
--- Extraction Results ---`),console.log("Appeal Reference:",s.appealReferenceNumber),console.log("Site Visit Date:",s.siteVisitDate),console.log("Decision Date:",s.decisionDate),console.log("LPA:",s.lpa),console.log("Inspector:",s.inspector),console.log("Decision Outcome:",s.decisionOutcome),console.log(`=== END DEBUG ===
`)),s}function F(t,s){const a=[t,s],n=[/[A-Z0-9\/]+\/\d{7}/gi,/(?:Appeal\s+(?:Ref|Reference)[:\s]+)([A-Z0-9\/]+\/\d{7})/gi,/(?:Ref[:\s]+)([A-Z0-9\/]+\/\d{7})/gi];for(const r of a)for(const i of n){const o=r.match(i);if(o){let e=o[1]||o[0];if(/\d{7}$/.test(e)&&e.includes("/"))return console.log(`Found appeal reference: ${e}`),e.toUpperCase()}}return"NOT_FOUND"}function x(t,s){const a=[t,s],n=[/Site visit made on ([^\n\r.]+)/i,/Site\s+visit\s+made\s+on\s+([^\n\r.]+)/i];for(const r of a)for(const i of n){const o=r.match(i);if(o&&o[1]){let e=o[1].trim();return console.log(`Found site visit date: ${e}`),b(e)}}return"NOT_FOUND"}function R(t,s){const a=[t,s],n=[/Decision date:\s*([^\n\r.]+)/i,/Decision\s+date:\s*([^\n\r.]+)/i];for(const r of a)for(const i of n){const o=r.match(i);if(o&&o[1]){let e=o[1].trim();return e=e.replace(/\.$/,""),console.log(`Found decision date: ${e}`),b(e)}}return"NOT_FOUND"}function S(t,s){const a=[t,s],n=[/against the decision of ([^.\n\r]+)/i,/•.*?against the decision of ([^.\n\r]+)/i];for(const r of a)for(const i of n){const o=r.match(i);if(o&&o[1]){let e=o[1].trim();if(e=e.replace(/^(the\s+)?/gi,"").replace(/\s+/g," ").replace(/[.,;]$/,"").trim(),e.length>5&&!/^(decision|appeal|the\s)/i.test(e))return console.log(`Found LPA: ${e}`),e}}return"NOT_FOUND"}function k(t,s){const a=[t,s],n=[/by ([A-Z][A-Za-z ]+?) (?:[A-Z]{2,}|an Inspector)/i,/by ([A-Z][A-Za-z ]+?) (?:BA|BSc|MSc|MRTPI|RIBA|Dip|Arch|Hons|PGCE|FRICS|FAAV|RTPI|PGDip|MA)/i];for(const r of a)for(const i of n){const o=r.match(i);if(o&&o[1]){let e=o[1].trim();if(e=e.replace(/\s+(BA|BSc|MSc|MRTPI|RIBA|Dip\.|Arch|Hons|PGCE|FRICS|FAAV|RTPI|F\s*RTPI|PGDip|MA).*$/gi,"").replace(/\s+/g," ").trim(),e.length>=3&&/^[A-Z]/.test(e)&&e.includes(" "))return console.log(`Found inspector: ${e}`),e}}return"NOT_FOUND"}function $(t,s){const a=[t,s],n=[/Decision[:\s]*[^\n\r]*?(dismissed|allowed)/i,/The\s+appeal\s+is\s+(dismissed|allowed)/i,/appeal.*?is\s+(dismissed|allowed)/i];for(const r of a)for(const i of n){const o=r.match(i);if(o&&o[1]){const e=o[1].toLowerCase();if(e==="dismissed")return console.log("Found decision outcome: Dismissed"),"Dismissed";if(e==="allowed")return console.log("Found decision outcome: Allowed"),"Allowed"}}return"NOT_FOUND"}function b(t){return!t||typeof t!="string"?"NOT_FOUND":t.trim()}let l=null;function U(t,s,a){if(!t||!t.items||!Array.isArray(t.items))return"";const n=t.items.filter(e=>e&&typeof e.str=="string"&&e.str.trim()).map(e=>({text:e.str.trim(),x:e.transform?e.transform[4]:0,y:e.transform?e.transform[5]:0,height:e.height||0})).filter(e=>e.text.length>0);if(n.length===0)return"";n.sort((e,d)=>{const c=d.y-e.y;return Math.abs(c)>5?c:e.x-d.x});const r=[];let i=[],o=n[0]?.y;for(const e of n)if(Math.abs(e.y-o)>5){if(i.length>0){const d=i.map(c=>c.text).join(" ");A(d)||r.push(d)}i=[e],o=e.y}else i.push(e);if(i.length>0){const e=i.map(d=>d.text).join(" ");A(e)||r.push(e)}return r.join(`
`).trim()}function A(t,s,a){const n=t.toLowerCase().trim();if(n.length<3)return!0;const r=[/^page\s*\d+/i,/^\d+\s*$/,/^\d+\s*of\s*\d+/i,/^\d+\s*\/\s*\d+/,/©.*\d{4}/i,/copyright.*\d{4}/i,/all rights reserved/i,/^ref:/i,/^document\s*(id|number)/i,/^version\s*\d/i,/www\./i,/\.com/i,/\.org/i,/\.gov/i,/@\w+\./i,/^confidential$/i,/^draft$/i,/^final$/i,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const i of r)if(i.test(n))return!0;return!!(n.length<10&&/^[\d\s\-\/\(\)\.]+$/.test(n))}function E(t){if(!t||typeof t!="string")return"";const a=t.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/[ \t]+/g," ").replace(/\n[ \t]+/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{4,}/g,`


`).replace(/\f/g,"").replace(/\u00A0/g," ").replace(/[\u2000-\u200B]/g," ").replace(/(\w)-\n(\w)/g,"$1$2").replace(/[""]/g,'"').replace(/['']/g,"'").replace(/\s+([.,;:!?])/g,"$1").trim().split(`
`),n=[];let r="";for(const i of a){const o=i.trim();(o!==r||o==="")&&(n.push(i),r=o)}return n.join(`
`).trim()}async function I(){if(!l)try{try{l=await import("./pdf-Dg2IMGHT.js")}catch{l=await import("./pdf-Dg2IMGHT.js")}l.GlobalWorkerOptions?l.GlobalWorkerOptions.workerSrc="https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.worker.min.mjs":l.default&&l.default.GlobalWorkerOptions&&(l.default.GlobalWorkerOptions.workerSrc="https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.worker.min.mjs")}catch(t){throw console.error("Failed to initialize PDF.js:",t),t}return l}let m=!1,p={total:0,completed:0,failed:0,status:"idle"};self.onmessage=async t=>{const{type:s,payload:a}=t.data;try{switch(s){case"process-batch":await _(a.files,a.startIndex);break;case"pause":m=!0,p.status="paused",g();break;case"resume":m=!1,p.status="processing",g();break}}catch(n){self.postMessage({type:"error",payload:n instanceof Error?n.message:"Unknown error"})}};async function _(t,s){p={total:t.length,completed:0,failed:0,status:"processing"};try{await I()}catch(r){p.status="error",p.failed=t.length,g(),self.postMessage({type:"error",payload:`PDF.js initialization failed: ${r instanceof Error?r.message:"Unknown error"}`});return}const a=5,n=[];for(let r=0;r<t.length;r+=a){m&&await T();const i=t.slice(r,r+a);for(const o of i){m&&await T(),p.current=o.name,g();try{const e=await j(o,s+o.index);n.push(e),p.completed++}catch{p.failed++}g()}self.postMessage({type:"complete",payload:{batch:n.slice(-a)}})}p.status="completed",p.current=void 0,g()}async function j(t,s){try{if(!l)throw new Error("PDF.js not initialized");if(!t.data||t.data.byteLength===0)throw new Error("Empty PDF data");const a=new Uint8Array(t.data);if(!new TextDecoder().decode(a.slice(0,5)).startsWith("%PDF"))throw new Error("Invalid PDF format - missing PDF header");const i=(l.default||l).getDocument({data:a,verbosity:0,disableAutoFetch:!1,disableStream:!1,disableRange:!1}),o=await Promise.race([i.promise,new Promise((u,h)=>setTimeout(()=>h(new Error("PDF loading timeout after 30 seconds")),3e4))]);let e="";const d=o.numPages;for(let u=1;u<=d;u++){m&&await T();try{const h=await o.getPage(u),N=await h.getTextContent(),y=U(N,u,d);y.trim()&&(e+=y+`

`),h.cleanup()}catch{}}e=E(e);const c=P(e);let D;try{D=await o.getMetadata()}catch{D={info:{}}}const f=D?.info||{},w={id:`doc_${s}`,filename:t.name,size:t.size,uploadDate:new Date,processingStatus:"completed",metadata:{pageCount:o.numPages,title:f.Title||t.name,author:f.Author||"Unknown",subject:f.Subject||"",keywords:f.Keywords||"",appealReferenceNumber:c.appealReferenceNumber,siteVisitDate:c.siteVisitDate,decisionDate:c.decisionDate,lpa:c.lpa,inspector:c.inspector,decisionOutcome:c.decisionOutcome}},O={docId:w.id,content:e.trim()||`Document: ${t.name} (${o.numPages} pages)`,metadata:{pageCount:o.numPages,title:f.Title||t.name,author:f.Author||"Unknown",subject:f.Subject||"",keywords:f.Keywords||"",appealReferenceNumber:c.appealReferenceNumber,siteVisitDate:c.siteVisitDate,decisionDate:c.decisionDate,lpa:c.lpa,inspector:c.inspector,decisionOutcome:c.decisionOutcome}};return o.cleanup(),{document:w,searchIndex:O}}catch(a){throw a}}function g(){self.postMessage({type:"progress",payload:p})}async function T(){return new Promise(t=>{const s=()=>{m?setTimeout(s,100):t()};s()})}
