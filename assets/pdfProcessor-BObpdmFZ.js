let i=null;function j(e,c,n){if(!e||!e.items||!Array.isArray(e.items))return"";const r=e.items.filter(t=>t&&typeof t.str=="string"&&t.str.trim()).map(t=>({text:t.str.trim(),x:t.transform?t.transform[4]:0,y:t.transform?t.transform[5]:0,height:t.height||0})).filter(t=>t.text.length>0);if(r.length===0)return"";r.sort((t,d)=>{const u=d.y-t.y;return Math.abs(u)>5?u:t.x-d.x});const s=[];let o=[],a=r[0]?.y;for(const t of r)if(Math.abs(t.y-a)>5){if(o.length>0){const d=o.map(u=>u.text).join(" ");P(d)||s.push(d)}o=[t],a=t.y}else o.push(t);if(o.length>0){const t=o.map(d=>d.text).join(" ");P(t)||s.push(t)}return s.join(`
`).trim()}function P(e,c,n){const r=e.toLowerCase().trim();if(r.length<3)return!0;const s=[/^page\s*\d+/i,/^\d+\s*$/,/^\d+\s*of\s*\d+/i,/^\d+\s*\/\s*\d+/,/Â©.*\d{4}/i,/copyright.*\d{4}/i,/all rights reserved/i,/^ref:/i,/^document\s*(id|number)/i,/^version\s*\d/i,/www\./i,/\.com/i,/\.org/i,/\.gov/i,/@\w+\./i,/^confidential$/i,/^draft$/i,/^final$/i,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const o of s)if(o.test(r))return!0;return!!(r.length<10&&/^[\d\s\-\/\(\)\.]+$/.test(r))}function D(e){if(!e||typeof e!="string")return"";const n=e.replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/[ \t]+/g," ").replace(/\n[ \t]+/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{4,}/g,`


`).replace(/\f/g,"").replace(/\u00A0/g," ").replace(/[\u2000-\u200B]/g," ").replace(/(\w)-\n(\w)/g,"$1$2").replace(/[""]/g,'"').replace(/['']/g,"'").replace(/\s+([.,;:!?])/g,"$1").trim().split(`
`),r=[];let s="";for(const o of n){const a=o.trim();(a!==s||a==="")&&(r.push(o),s=a)}return r.join(`
`).trim()}async function T(){if(!i)try{try{i=await import("./pdf-Dg2IMGHT.js")}catch{i=await import("./pdf-Dg2IMGHT.js")}i.GlobalWorkerOptions?i.GlobalWorkerOptions.workerSrc="https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.worker.min.mjs":i.default&&i.default.GlobalWorkerOptions&&(i.default.GlobalWorkerOptions.workerSrc="https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.worker.min.mjs")}catch(e){throw console.error("Failed to initialize PDF.js:",e),e}return i}let m=!1,l={total:0,completed:0,failed:0,status:"idle"};self.onmessage=async e=>{const{type:c,payload:n}=e.data;try{switch(c){case"process-batch":await $(n.files,n.startIndex);break;case"pause":m=!0,l.status="paused",g();break;case"resume":m=!1,l.status="processing",g();break}}catch(r){self.postMessage({type:"error",payload:r instanceof Error?r.message:"Unknown error"})}};async function $(e,c){l={total:e.length,completed:0,failed:0,status:"processing"};try{await T()}catch(s){l.status="error",l.failed=e.length,g(),self.postMessage({type:"error",payload:`PDF.js initialization failed: ${s instanceof Error?s.message:"Unknown error"}`});return}const n=5,r=[];for(let s=0;s<e.length;s+=n){m&&await w();const o=e.slice(s,s+n);for(const a of o){m&&await w(),l.current=a.name,g();try{const t=await F(a,c+a.index);r.push(t),l.completed++}catch{l.failed++}g()}self.postMessage({type:"complete",payload:{batch:r.slice(-n)}})}l.status="completed",l.current=void 0,g()}async function F(e,c){try{if(!i)throw new Error("PDF.js not initialized");if(!e.data||e.data.byteLength===0)throw new Error("Empty PDF data");const n=new Uint8Array(e.data);if(!new TextDecoder().decode(n.slice(0,5)).startsWith("%PDF"))throw new Error("Invalid PDF format - missing PDF header");const o=(i.default||i).getDocument({data:n,verbosity:0,disableAutoFetch:!1,disableStream:!1,disableRange:!1}),a=await Promise.race([o.promise,new Promise((f,h)=>setTimeout(()=>h(new Error("PDF loading timeout after 30 seconds")),3e4))]);let t="";const d=a.numPages;for(let f=1;f<=d;f++){m&&await w();try{const h=await a.getPage(f),x=await h.getTextContent(),b=j(x,f,d);b.trim()&&(t+=b+`

`),h.cleanup()}catch{}}t=D(t);let u;try{u=await a.getMetadata()}catch{u={info:{}}}const p=u?.info||{},y={id:`doc_${c}`,filename:e.name,size:e.size,uploadDate:new Date,processingStatus:"completed",metadata:{pageCount:a.numPages,title:p.Title||e.name,author:p.Author||"Unknown",subject:p.Subject||"",keywords:p.Keywords||""}},k={docId:y.id,content:t.trim()||`Document: ${e.name} (${a.numPages} pages)`,metadata:{pageCount:a.numPages,title:p.Title||e.name,author:p.Author||"Unknown",subject:p.Subject||"",keywords:p.Keywords||""}};return a.cleanup(),{document:y,searchIndex:k}}catch(n){throw n}}function g(){self.postMessage({type:"progress",payload:l})}async function w(){return new Promise(e=>{const c=()=>{m?setTimeout(c,100):e()};c()})}
